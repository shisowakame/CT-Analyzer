# CT-Analyzer: DICOM画像解析ツール

## 概要

CT-Analyzerは、複数のDICOM画像シリーズを同時に読み込み、ROI（Region of Interest）解析を行う医療画像解析ツールです。Webベースのインターフェースで、直感的な操作が可能です。

## 主な機能

- **マルチシリーズ同時表示**: 複数のDICOMフォルダを同時に読み込み、比較解析
- **ROI解析**: 可変サイズのROI設定、同期/独立モード切り替え
- **統計計算**: ROI内の平均値・標準偏差をリアルタイム計算（HU値ベース）
- **履歴管理**: 統計結果の保存・表示・Excelエクスポート
- **画像保存**: 表示画像の保存（ROI含む/含まない）
- **諧調揃え**: 複数シリーズ間での画素値の統一表示
- **フォルダ切り替え**: 複数フォルダの動的切り替え

## セットアップ

### 前提条件
- Python 3.8以上
- pip

### インストール

1. リポジトリをクローン
```bash
git clone <repository-url>
cd CT-Analyzer
```

2. 依存関係をインストール
```bash
pip install -r requirements.txt
```

3. アプリケーションを起動
```bash
python gui/dicom_webview.py <folder1> [<folder2> ...]
```

## 使用方法

### 基本的な操作

1. **DICOMフォルダの指定**
   - 単一フォルダ: `python gui/dicom_webview.py /path/to/folder1`
   - 複数フォルダ: `python gui/dicom_webview.py /path/to/folder1 /path/to/folder2`

2. **フォルダ構造**
   - **folder1**: 単一のDICOMフォルダ
   - **folder2**: 複数のDICOMフォルダを含む親フォルダ

### ROI操作

- **ROI設定**: 画像上をクリックしてROIを設定
- **サイズ変更**: ツールバーの数値入力でROIサイズを変更（3-200ピクセル）
- **プリセット**: 5×5, 10×10, 20×20, 50×50のプリセットサイズ
- **色変更**: カラーピッカーでROIの色を変更
- **リセット**: 「ROI削除」ボタンで全ROIをクリア

### モード切り替え

- **同期モード**: 全シリーズで同じROI位置を使用
- **独立モード**: 各シリーズで独立したROI設定

### 統計解析

- **リアルタイム計算**: ROI設定時に即座に平均値・標準偏差を計算
- **HU値解析**: 正規化前の元データ（HU値）を使用
- **座標入力**: 数値でROI座標を直接入力可能

### 履歴管理

- **保存**: Ctrl+Sまたは保存ボタンで統計履歴を保存
- **表示**: 右パネルで履歴テーブルを表示
- **削除**: 履歴の個別行を削除可能
- **平均計算**: 履歴データの平均値を自動計算
- **Excelエクスポート**: 履歴データをExcelファイルとして保存

### 画像保存

- **表示画像保存**: 現在表示中の画像をPNG形式で保存
- **ROI含む保存**: ROIを描画した状態で画像を保存
- **個別・結合保存**: 各シリーズの個別画像と結合画像の両方を保存

### その他の機能

- **諧調揃え**: ON/OFFで複数シリーズ間の画素値表示を統一
- **フォルダ切り替え**: フォルダ2の場合、ドロップダウンでフォルダを切り替え
- **メタデータ表示**: DICOMメタデータの検索・表示
- **スライダー操作**: 個別・全体スライダーでスライスを切り替え

## 技術仕様

### 使用技術
- **Python 3.8+**: メイン開発言語
- **pywebview**: WebベースGUI
- **PyDICOM**: DICOMファイル処理
- **NumPy**: 数値計算
- **Pillow**: 画像処理
- **Pandas**: データ分析
- **openpyxl**: Excel出力

### 対応フォルダ構造
- 単一DICOMフォルダ
- 複数DICOMフォルダを含む親フォルダ
- 自動フォルダタイプ判定

## トラブルシューティング

### よくある問題

**pywebviewエラー**
```
System.ArgumentException: 'DicomWebApi' value cannot be converted to System.Drawing.Rectangle
```
解決方法: `debug=False`で起動

**メモリ不足**
解決方法: 大きなDICOMファイルの場合は、フォルダを分割して読み込み

**SyntaxWarning**
解決方法: 正規表現のエスケープを修正済み

## ライセンス

MIT License

## サポート

問題報告や機能要求は、GitHub Issuesでお願いします。